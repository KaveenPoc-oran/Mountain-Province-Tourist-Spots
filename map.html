<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Map - Mountain Province</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        #map { height: 550px; width: 100%; border-radius: 15px; margin-top: 20px; }
        .map-filters { margin-bottom: 20px; }
        .legend span { margin-right: 20px; }
    </style>
</head>
<body>

    <!-- Navigation (same as index.html) -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html"><i class="fas fa-mountain"></i> Mt. Province Tourism</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link active" href="map.html">Interactive Map</a></li>
                    <li class="nav-item"><a class="nav-link" href="emergency.html">Emergency</a></li>
                    <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
                    <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
                    <li class="nav-item"><a class="nav-link" href="../admin/login.html" target="_blank"><i class="fas fa-lock"></i> Admin</a></li>
                </ul>
                <span class="badge bg-warning text-dark ms-3">Guest Mode</span>
            </div>
        </div>
    </nav>

    <main class="container mt-5">
        <h2 class="section-title"><i class="fas fa-map-marked-alt"></i> Interactive Map</h2>
        <p class="lead">Click markers to view spot details and get directions.</p>

        <!-- Municipality filter buttons -->
        <div class="map-filters">
            <span class="fw-bold me-2">Filter:</span>
            <button id="filterAll" class="btn btn-sm btn-primary active">All</button>
            <button id="filterSagada" class="btn btn-sm btn-outline-primary">Sagada</button>
            <button id="filterBontoc" class="btn btn-sm btn-outline-primary">Bontoc</button>
            <button id="filterBarlig" class="btn btn-sm btn-outline-primary">Barlig</button>
            <button id="filterSadanga" class="btn btn-sm btn-outline-primary">Sadanga</button>
            <button id="filterBauko" class="btn btn-sm btn-outline-primary">Bauko</button>
            <button id="filterTadian" class="btn btn-sm btn-outline-primary">Tadian</button>
        </div>

        <!-- Map container -->
        <div id="map"></div>

        <!-- Legend -->
        <div class="legend mt-3 p-3 bg-light rounded">
            <h6><i class="fas fa-info-circle"></i> Map Legend</h6>
            <span><span class="badge bg-danger">●</span> Cultural</span>
            <span class="ms-3"><span class="badge bg-success">●</span> Nature</span>
            <span class="ms-3"><span class="badge bg-primary">●</span> Adventure</span>
            <span class="ms-3"><span class="badge bg-warning text-dark">●</span> Viewpoint</span>
        </div>
    </main>

    <!-- Footer (same as index.html) -->
    <footer class="footer mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5>Mountain Province Tourism</h5>
                    <p>Your official guide to the wonders of the Cordilleras.</p>
                </div>
                <div class="col-md-4">
                    <h5>Quick Links</h5>
                    <ul class="list-unstyled">
                        <li><a href="index.html">Home</a></li>
                        <li><a href="map.html">Interactive Map</a></li>
                        <li><a href="emergency.html">Emergency Contacts</a></li>
                        <li><a href="about.html">About</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5>Contact</h5>
                    <p><i class="fas fa-phone"></i> (074) 123-4567</p>
                    <p><i class="fas fa-envelope"></i> tourism@mountainprovince.ph</p>
                    <p><i class="fas fa-map-marker-alt"></i> Bontoc, Mountain Province</p>
                </div>
            </div>
            <hr>
            <p class="text-center mb-0">&copy; 2024 Mountain Province State University – All rights reserved.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="assets/js/script.js"></script>
    <script>
        // ---------- MAP INITIALIZATION ----------
        const map = L.map('map').setView([17.0833, 120.9167], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        let markers = [];
        let allSpots = [];

        // Load spots from localStorage (via script.js) and draw markers
        function loadMapSpots() {
            allSpots = getSpots();  // from script.js
            addMarkers(allSpots);
        }

        // Add markers for given spots array
        function addMarkers(spots) {
            // Clear existing markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            spots.forEach(spot => {
                if (spot.lat && spot.lng) {
                    let iconColor = 'red';
                    if (spot.category === 'Nature') iconColor = 'green';
                    else if (spot.category === 'Adventure') iconColor = 'blue';
                    else if (spot.category === 'Viewpoint') iconColor = 'gold';

                    const marker = L.marker([spot.lat, spot.lng], {
                        icon: L.icon({
                            iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${iconColor}.png`,
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).bindPopup(`
                        <b>${spot.name}</b><br>
                        ${spot.municipality}<br>
                        <small>${spot.description.substring(0, 60)}...</small><br>
                        <a href="spot-details.html?id=${spot.id}" class="btn btn-sm btn-primary mt-1">View Details</a>
                    `);
                    marker.addTo(map);
                    markers.push(marker);
                }
            });
        }

        // Expose refresh function for live sync (called from script.js storage event)
        window.refreshMapMarkers = function(spots) {
            allSpots = spots;
            addMarkers(spots);
        };

        // ---------- FILTER BUTTONS ----------
        function setActive(btn) {
            document.querySelectorAll('.map-filters .btn').forEach(b => {
                b.classList.remove('active', 'btn-primary');
                b.classList.add('btn-outline-primary');
            });
            btn.classList.add('active', 'btn-primary');
            btn.classList.remove('btn-outline-primary');
        }

        document.getElementById('filterAll').addEventListener('click', function() {
            setActive(this);
            addMarkers(allSpots);
        });
        document.getElementById('filterSagada').addEventListener('click', function() {
            setActive(this);
            addMarkers(allSpots.filter(s => s.municipality === 'Sagada'));
        });
        document.getElementById('filterBontoc').addEventListener('click', function() {
            setActive(this);
            addMarkers(allSpots.filter(s => s.municipality === 'Bontoc'));
        });
        document.getElementById('filterBarlig').addEventListener('click', function() {
            setActive(this);
            addMarkers(allSpots.filter(s => s.municipality === 'Barlig'));
        });
        document.getElementById('filterSadanga').addEventListener('click', function() {
            setActive(this);
            addMarkers(allSpots.filter(s => s.municipality === 'Sadanga'));
        });
        document.getElementById('filterBauko').addEventListener('click', function() {
            setActive(this);
            addMarkers(allSpots.filter(s => s.municipality === 'Bauko'));
        });
        document.getElementById('filterTadian').addEventListener('click', function() {
            setActive(this);
            addMarkers(allSpots.filter(s => s.municipality === 'Tadian'));
        });

        // ---------- INITIAL LOAD ----------
        loadMapSpots();
    </script>
</body>
</html>